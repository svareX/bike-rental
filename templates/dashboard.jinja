{% extends '__main.jinja' %}

{% block content %}
    <div class="main">
        <div class="box dashboard">
            <h2>Přehled</h2>
            <p>
                Vítejte v půjčovně kol. <br>
                {% if session['authenticated'] %}
                Aktuálně jste přihlášen jako: {{ session['email'] }}
                {% else %}
                Aktuálně nejste přihlášen.
                {% endif %}
            </p>
            <div class="filter">
                <form method="GET" action="{{ url_for('view_dashboard_page') }}"
                      onsubmit="return cleanEmptyParams(this)">
                    <label for="brand">Filtr podle značky:</label>
                    <select name="brand_id" id="brand">
                        <option value="" {% if not selected_brand %}selected{% endif %}>Všechny značky</option>
                        {% for brand in brands %}
                            <option value="{{ brand.id }}"
                                    {% if selected_brand == brand.id|string %}selected{% endif %}>
                                {{ brand.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <br>
                    <label for="search">Vyhledat:</label>
                    <input
                            type="text"
                            name="search"
                            id="search"
                            placeholder="Název kola"
                            value="{{ search_query or '' }}"
                    />
                    <br>
                    <button type="submit">Hledat</button>
                    {% if selected_brand or search_query %}
                        <a href="{{ url_for('view_dashboard_page') }}">
                            <button type="button">Resetovat filtry</button>
                        </a>
                    {% endif %}
                </form>
            </div>
            <hr>
            {% if session['role'] == 1 %}
            <a href={{ url_for("add_bike.page") }}>Přidat kolo</a>
            {% endif %}
            <div class="grid">
                {% if bikes %}
                    {% for bike in bikes %}
                        <div class="bike">
                            <p class="bike-header">
                                <span>
                                    {{ bike.brand_name }}
                                </span>
                                <span>
                                    <b>{{ bike.name }}</b>
                                </span>
                            </p>
                            <img src="{{ url_for('static', filename='img/' + bike.img) }}" alt="{{ bike.name }}" class="bike-img">
                            <p class="bike-price">Cena na den: <span>{{ bike.price_per_day }}</span></p>
                            <br>

                            {% if session['role'] == 1 %}
                                <a href="{{ url_for('edit_bike.page', bike_id=bike.id) }}">
                                    <button>Upravit</button>
                                </a>
                                <a href="{{ url_for('delete_bike.page', bike_id=bike.id) }}">
                                    <button>Smazat</button>
                                </a>
                            {% elif session['role'] == 0 %}
                                {% if is_rented(bike.id) == 0 or is_rented(bike.id) == 3 %}
                                    <a href="{{ url_for('rent_bike.page', user_id=session['user_id'], bike_id=bike.id) }}">
                                        <button>Vypůjčit si</button>
                                    </a>
                                {% elif is_rented(bike.id) == 1 %}
                                    <b>Kolo je již zapůjčeno do: {{ getRentDate(bike.id).date_to }}</b>
                                {% else %}
                                    <b>Kolo se vyřizuje zaměstnanci.</b>
                                {% endif %}
                            {% endif %}
                            <hr>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        function cleanEmptyParams(form) {
            const searchInput = form.querySelector('input[name="search"]');
            if (searchInput && searchInput.value.trim() === '') {
                searchInput.disabled = true;
            }
            return true;
        }
    </script>
{% endblock %}